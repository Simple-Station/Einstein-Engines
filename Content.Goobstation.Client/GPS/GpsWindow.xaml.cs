using Content.Goobstation.Shared.GPS;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.Graphics;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
using System.Linq;
using Robust.Client.ResourceManagement;
using Content.Client.Resources;
using System.Numerics;
using Content.Goobstation.Shared.GPS.Components;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Shared.Timing;

namespace Content.Goobstation.Client.GPS;

[GenerateTypedNameReferences]
public sealed partial class GpsWindow : BaseWindow
{
    [Dependency] private readonly IEntityManager _entityManager = default!;
    [Dependency] private readonly IPrototypeManager _prototypeManager = default!;
    [Dependency] private readonly IResourceCache _cache = default!;
    [Dependency] private readonly IGameTiming _timing = default!;

    private readonly SharedTransformSystem _transform;
    private readonly SpriteSystem _sprite;

    public event Action<NetEntity?>? TrackedEntitySelected;
    public event Action<string>? GpsNameChanged;
    public event Action<bool>? DistressPressed;

    public event Action<bool>? EnabledPressed;

    private readonly Texture? _distressSprite;

    private EntityUid _owner;
    private bool _inDistress;
    private bool _enabled;

    private string? _lastEnteredText;
    private List<GpsEntry> _previousEntry = new();

    public GpsWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        _distressSprite = _cache.GetTexture("/Textures/_Goobstation/Interface/Emotes/surprised.png");
        _transform = _entityManager.System<SharedTransformSystem>();
        _sprite = _entityManager.System<SpriteSystem>();

        ClearButton.OnPressed += _ => TrackedEntitySelected?.Invoke(null);
        GpsName.OnTextEntered += GpsNameOnOnTextEntered;
        DistressButton.OnPressed += _ => DistressPressed?.Invoke(!_inDistress);
        EnabledButton.OnPressed += _ => EnabledPressed?.Invoke(!_enabled);
        CloseButton.OnPressed += _ => Close();
    }

    private void GpsNameOnOnTextEntered(LineEdit.LineEditEventArgs e)
    {
        _lastEnteredText = e.Text;
        GpsNameChanged?.Invoke(e.Text);
    }

    public void UpdateState(EntityUid owner)
    {
        if (!_entityManager.TryGetComponent(owner, out GPSComponent? gps))
            return;

        if (string.IsNullOrEmpty(_lastEnteredText))
            _lastEnteredText = gps.GpsName;

        _inDistress = gps.InDistress;
        _enabled = gps.Enabled;
        _owner = owner;

        EnabledButton.Text = gps.Enabled ? Loc.GetString("gps-window-visibility-on") : Loc.GetString("gps-window-visibility-off");
        DistressButton.ModulateSelfOverride = gps.InDistress ? Color.Red : null;

        if (_lastEnteredText != gps.GpsName && _timing.IsFirstTimePredicted)
            GpsName.Text = _lastEnteredText;

        UpdateTrackedEntity(gps.GpsEntries, gps.TrackedEntity);
        UpdateGpsEntries(gps.GpsEntries, gps.TrackedEntity);

        var gpsPos = _transform.GetMapCoordinates(owner);
        CompassContainer.SetState(gpsPos, gps.TrackedEntity, gps.GpsEntries);
    }

    public void UpdateGpsName(EntityUid owner)
    {
        if (_entityManager.TryGetComponent(owner, out GPSComponent? gps))
            GpsName.Text = gps.GpsName;
    }

    public void UpdateTrackedEntity(List<GpsEntry> gpsEntries, NetEntity? trackedEntity)
    {
        if (trackedEntity.HasValue)
        {
            var trackedEntry = gpsEntries.FirstOrDefault(e => e.NetEntity == trackedEntity.Value);
            if (trackedEntry != null)
            {
                var coords = trackedEntry.Coordinates;
                TrackedPositionLabel.Text = $"{coords.X:F0}, {coords.Y:F0}";
            }
            else
                TrackedPositionLabel.Text = Loc.GetString("gps-window-position-unknown");
        }
        else
            TrackedPositionLabel.Text = Loc.GetString("gps-window-position-none");
    }

    public void UpdateGpsEntries(List<GpsEntry> gpsEntries, NetEntity? trackedEntity)
    {
        var sortedEntries = gpsEntries
            .OrderByDescending(e => e.IsDistress)
            .ThenBy(e =>
            {
                if (e.PrototypeId == null)
                    return false;

                var proto = _prototypeManager.Index<EntityPrototype>(e.PrototypeId);
                return proto.Components.ContainsKey("NavMapBeacon");
            })
            .ThenBy(e => e.Name)
            .ToList();

        if (sortedEntries.SequenceEqual(_previousEntry))
        {
            // Don't update if visual info wasn't changed (update only selection)
            UpdateSelectedEntry(trackedEntity);
            return;
        }

        _previousEntry = sortedEntries;

        GpsList.DisposeAllChildren();

        foreach (var entry in sortedEntries)
        {
            const int maxLength = 10;

            var text = entry.Name ?? Loc.GetString("generic-unknown-title");
            text = text.Length > maxLength ? text.Substring(0, maxLength) : text;

            IRsiStateLike? sprite;
            if (entry.IsDistress)
            {
                sprite = _distressSprite;
            }
            else if (entry.PrototypeId != null)
            {
                var icon = _sprite.GetPrototypeIcon(entry.PrototypeId);
                sprite = icon.Default;
            }
            else
            {
                var icon = _sprite.GetPrototypeIcon("HandheldGPS");
                sprite = icon.Default;
            }

            var item = new GpsListEntry(text, entry.NetEntity, sprite, entry.Color);

            item.OnPressed += _ => TrackedEntitySelected?.Invoke(entry.NetEntity);

            GpsList.AddChild(item);
        }

        UpdateSelectedEntry(trackedEntity);
    }

    private void UpdateSelectedEntry(NetEntity? trackedEntity)
    {
        foreach (var control in GpsList.Children)
        {
            var entry = (GpsListEntry) control;
            entry.Pressed = trackedEntity == entry.TrackedEntity;
        }
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        base.FrameUpdate(args);

        var mapCoords = _transform.GetMapCoordinates(_owner);
        GpsPositionLabel.Text = $"{mapCoords.Position.X:F0}, {mapCoords.Position.Y:F0}";
        CompassContainer.UpdatePosition(mapCoords);
    }

    protected override DragMode GetDragModeFor(Vector2 relativeMousePos)
    {
        return DragMode.Move;
    }
}
