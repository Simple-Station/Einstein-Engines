using System.Linq;
using System.Numerics;
using Content.Client.Guidebook;
using Content.Client.Humanoid;
using Content.Client.Lobby;
using Content.Client.Lobby.UI;
using Content.Client.Message;
using Content.Client.Players.PlayTimeTracking;
using Content.Client.Stylesheets;
using Content.Client.UserInterface.Controls;
using Content.Client.UserInterface.Systems.Guidebook;
using Content.Shared.CCVar;
using Content.Shared.Clothing;
using Content.Shared.GameTicking;
using Content.Shared.Humanoid;
using Content.Shared.Humanoid.Markings;
using Content.Shared.Humanoid.Prototypes;
using Content.Shared.Preferences;
using Content.Shared.Preferences.Loadouts;
using Content.Shared.Preferences.Loadouts.Effects;
using Content.Shared.Roles;
using Content.Shared.Traits;
using Robust.Shared.GameStates;
using Robust.Shared.ComponentTrees;
using Robust.Client.ComponentTrees;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.Graphics;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Client.Utility;
using Robust.Shared.Configuration;
using Robust.Shared.Enums;
using Robust.Shared.Prototypes;
using Robust.Shared.Utility;
using Direction = Robust.Shared.Maths.Direction;
using Robust.Client.ResourceManagement;
using Content.Client.Resources;
using Content.Shared.Chemistry.Reaction;

namespace Content.Client._Crescent
{
    [GenerateTypedNameReferences]
    public sealed partial class FactionSelectorGui : BoxContainer
    {
        private readonly IClientPreferencesManager _preferencesManager;
        private readonly IPrototypeManager _prototypeManager;
        [Dependency] private readonly SpriteSystem _sprite = default!;
        [Dependency] private readonly EntityManager _entities = default!;
        private readonly IResourceCache _resourceCache = default!;
        public HumanoidCharacterProfile? Profile;
        public event Action<HumanoidCharacterProfile, int>? OnProfileChanged;
        public CharacterSetupGui SetupUI;

        private BoxContainer _factionList => CFactionList;

        private Dictionary<Button, string> internalDirectory;

        private bool _isDirty;
        public int CharacterSlot;


        public FactionSelectorGui(IClientPreferencesManager preferencesManager, IPrototypeManager prototypeManager, CharacterSetupGui setupUI)
        {
            RobustXamlLoader.Load(this);
            _preferencesManager = preferencesManager;
            _prototypeManager = prototypeManager;
            SetupUI = setupUI;
            internalDirectory = new Dictionary<Button, string>();

            var controller = UserInterfaceManager.GetUIController<LobbyUIController>();

            if (preferencesManager.ServerDataLoaded)
            {
                LoadServerData();
            }


            preferencesManager.OnServerDataLoaded += LoadServerData;
            IsDirty = false;
            controller.UpdateProfile();
        }

        private void SetDirty()
        {
            var controller = UserInterfaceManager.GetUIController<LobbyUIController>();
            controller.UpdateProfile(Profile);
            controller.ReloadCharacterUI();
            IsDirty = true;
        }

        private void SetFaction(FactionPrototype faction)
        {
            if (Profile is null)
                return;

            Profile = Profile.WithFaction(faction.ID);
            SetDirty();
        }

        protected override void Dispose(bool disposing)
        {
            base.Dispose(disposing);
            if (!disposing)
                return;

            _preferencesManager.OnServerDataLoaded -= LoadServerData;
        }

        public void LoadServerData()
        {
            Profile = (HumanoidCharacterProfile) _preferencesManager.Preferences!.SelectedCharacter;
            CharacterSlot = _preferencesManager.Preferences.SelectedCharacterIndex;
        }

        public void UpdateUI()
        {
            _factionList.RemoveAllChildren();
            var factions = _prototypeManager.EnumeratePrototypes<FactionPrototype>().ToArray();
            foreach (var faction in factions)
            {
                if (!faction.Enabled)
                    continue;

                var factionButton = new Button();
                // SHORTENED FOR UI's sake
                factionButton.Text = faction.ID;
                var factionName = new Label();
                factionName.HorizontalAlignment = HAlignment.Center;
                var factionPhoto = new TextureRect();
                factionPhoto.Stretch = TextureRect.StretchMode.Scale;
                var factionDesc = new Label();
                factionDesc.MaxWidth = 1012f;
                factionDesc.HorizontalAlignment = HAlignment.Center;
                factionButton.OnPressed += _ =>
                {
                    SetFaction(faction);
                    FactionInfo.RemoveAllChildren();
                    factionDesc.Text = faction.Description;
                    factionPhoto.Texture = faction.Icon.Frame0();
                    factionPhoto.SetHeight = 189f;
                    factionPhoto.SetWidth = 1012f;
                    FactionInfo.AddChild(factionPhoto);
                    FactionInfo.AddChild(factionDesc);
                };
                _factionList.AddChild(factionButton);

            }
            var confirmButton = new Button();
            var separator = new PanelContainer();
            separator.ModulateSelfOverride = Color.Black;
            separator.SetHeight = 10f;
            confirmButton.Text = "Confirm";
            confirmButton.SetHeight = 50f;
            confirmButton.ModulateSelfOverride = Color.Red;
            confirmButton.OnPressed += _ =>
            {
                FactionInfo.RemoveAllChildren();
                SetupUI.LockFaction();
                Save();
                SetupUI.SwitchToCharacterEditor();
            };
            _factionList.AddChild(separator);
            _factionList.AddChild(confirmButton);
        }

        public void Save()
        {
            IsDirty = false;

            if (Profile == null)
                return;

            _preferencesManager.UpdateCharacter(Profile, CharacterSlot);
            OnProfileChanged?.Invoke(Profile, CharacterSlot);
            // Reset profile to default.
            UserInterfaceManager.GetUIController<LobbyUIController>().UpdateProfile();
        }

        private bool IsDirty
        {
            get => _isDirty;
            set
            {
                _isDirty = value;
            }
        }
    }
}
